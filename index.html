<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ü—Ä–æ–±–µ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>

<style>
    body {
        margin: 0; padding: 0;
        font-family: "Segoe UI", sans-serif;
        background-image: url("car.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: 0.3s;
    }
    body.dark {
        background-color: #111;
        background-blend-mode: multiply;
        color: #fff;
    }
    .top-bar {
        display: flex;
        gap: 10px;
        justify-content: center;
        padding: 20px;
        background: rgba(255,255,255,0.12);
        backdrop-filter: blur(10px);
    }
    .btn {
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background: rgba(255,255,255,0.28);
        color: #fff;font-weight:600;
    }
    .btn.dark {
        background: #222;color:#f8f8f8;
    }
    .panel {
        max-width: 450px;
        margin: 50px auto;
        background: rgba(0,0,0,0.35);
        padding: 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        color: #fff;
        text-align: center;
    }
    input {
        width:100%;padding:10px;border-radius:8px;
        border:none;margin-bottom:15px;font-size:16px;
    }
    .modal {
        position: fixed; inset: 0;
        display: none; justify-content:center; align-items:center;
        background: rgba(0,0,0,0.65);
    }
    .modal.show { display:flex }
    .modal-content {
        background: #fff;
        padding: 25px;
        border-radius: 14px;
        width: 320px;
        text-align: center;
    }
    body.dark .modal-content{
        background:#222;color:white;
    }
    .close {
        position:absolute; right:20px; top:20px; cursor:pointer;
        font-size:22px;
    }

    .history-box {
        font-size:16px; text-align:left; margin-top:15px;
    }
</style>

</head>
<body>

<div class="top-bar">
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
    <button class="btn" id="regBtn">–°–æ–∑–¥–∞—Ç—å</button>
    <button class="btn" id="themeBtn">üåô</button>
</div>

<div class="panel">
    <div id="userInfo">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ</div>

    <input type="number" id="mileage" placeholder="–ü—Ä–æ–±–µ–≥ –≤ –∫–º" disabled>
    <button class="btn" id="saveMileage" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

    <button class="btn" id="logoutBtn" style="display:none;margin-top:10px;">–í—ã–π—Ç–∏</button>

    <div class="history-box" id="history"></div>
</div>


<!-- –õ–æ–≥–∏–Ω -->
<div class="modal" id="loginModal">
    <div class="modal-content">
        <span class="close" data-close="loginModal">√ó</span>
        <h3>–í—Ö–æ–¥</h3>
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" id="loginSubmit">–í–æ–π—Ç–∏</button>
    </div>
</div>

<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div class="modal" id="regModal">
    <div class="modal-content">
        <span class="close" data-close="regModal">√ó</span>
        <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" id="regSubmit">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<script type="module">
/*--------------------------------------------------
   üî• Firebase
--------------------------------------------------*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  signInWithEmailAndPassword, signOut,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import {
  getFirestore, addDoc, collection, query,
  orderBy, where, limit, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuTQ4a2znu4NezpilyL2QAyMQHt5SAozE",
  authDomain: "focus3-df69e.firebaseapp.com",
  projectId: "focus3-df69e",
  storageBucket: "focus3-df69e.appspot.com",
  messagingSenderId: "820116608318",
  appId: "1:820116608318:web:927be143470b2aa885c86f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/*--------------------------------------------------
   üåì –¢–µ–º–∞ ‚Äî —Ñ–∏–∫—Å–∏–º –æ—à–∏–±–∫—É
--------------------------------------------------*/
const themeBtn = document.getElementById("themeBtn");

function applyTheme(){
    if(localStorage.theme === "dark"){
        document.body.classList.add("dark");
        themeBtn.textContent = "‚òÄÔ∏è";
    } else {
        document.body.classList.remove("dark");
        themeBtn.textContent = "üåô";
    }
}
applyTheme();

themeBtn.onclick = ()=>{
    localStorage.theme = localStorage.theme === "dark" ? "light" : "dark";
    applyTheme();
};

/*--------------------------------------------------
   UI —ç–ª–µ–º–µ–Ω—Ç—ã
--------------------------------------------------*/
const loginModal = document.getElementById("loginModal");
const regModal = document.getElementById("regModal");
const loginBtn = document.getElementById("loginBtn");
const regBtn = document.getElementById("regBtn");
const logoutBtn = document.getElementById("logoutBtn");
const saveBtn = document.getElementById("saveMileage");

document.querySelectorAll(".close").forEach(c=>c.onclick=()=>{
    document.getElementById(c.dataset.close).classList.remove("show");
});

/*--------------------------------------------------
   üìå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
--------------------------------------------------*/
loginBtn.onclick = ()=>loginModal.classList.add("show");
regBtn.onclick = ()=>regModal.classList.add("show");

document.getElementById("loginSubmit").onclick = async ()=>{
    try{
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
        loginModal.classList.remove("show");
    } catch(e){ alert(e.message) }
};

document.getElementById("regSubmit").onclick = async ()=>{
    try{
        await createUserWithEmailAndPassword(auth, regEmail.value, regPass.value);
        regModal.classList.remove("show");
    } catch(e){ alert(e.message) }
};

logoutBtn.onclick = ()=>signOut(auth);

/*--------------------------------------------------
   üî• –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–µ–≥–∞
--------------------------------------------------*/
saveBtn.onclick = async ()=>{
    const mileage = +document.getElementById("mileage").value.trim();
    if(!auth.currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");
    if(!mileage) return alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–±–µ–≥!");

    await addDoc(collection(db, "mileages"), {
        uid: auth.currentUser.uid,
        mileage: mileage,
        date: new Date().toISOString()
    });

    // ‚ö° –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
    fetch("http://localhost:3000/analyze",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ uid: auth.currentUser.uid, mileage })
    });

    loadHistory();
};

/*--------------------------------------------------
   üìå –í—ã–≤–æ–¥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –∑–∞–ø–∏—Å–µ–π
--------------------------------------------------*/
async function loadHistory(){
    if(!auth.currentUser) return;

    const q = query(
        collection(db,"mileages"),
        where("uid","==",auth.currentUser.uid),
        orderBy("date","desc"),
        limit(5)
    );
    const snap = await getDocs(q);
    const h = document.getElementById("history");
    h.innerHTML = "";
    snap.forEach(d=>{
        const v = d.data();
        h.innerHTML += `‚Ä¢ ${v.mileage} –∫–º, –¥–∞—Ç–∞: ${new Date(v.date).toLocaleDateString()}<br>`;
    });
}

/*--------------------------------------------------
   üë§ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞
--------------------------------------------------*/
onAuthStateChanged(auth, user=>{
    if(user){
        document.getElementById("userInfo").textContent = `–í—ã –≤–æ—à–ª–∏: ${user.email}`;
        mileage.disabled = false;
        saveBtn.disabled = false;
        logoutBtn.style.display = "inline-block";
        loadHistory();
    } else {
        document.getElementById("userInfo").textContent = "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ";
        mileage.disabled = true;
        saveBtn.disabled = true;
        logoutBtn.style.display = "none";
        history.innerHTML = "";
    }
});
</script>
</body>
</html>
