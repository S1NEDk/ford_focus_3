<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ü—Ä–æ–±–µ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</title>

<style>
/* ===== –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ ===== */
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: url("car.jpg") center/cover no-repeat fixed;
  color: #fff;
  transition: 0.3s;
  padding-top: 100px;
}

body.dark {
  background-color: #0e0e0e;
  background-blend-mode: multiply;
}

/* ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ===== */
.top-bar {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 14px;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  z-index: 10;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: rgba(255,255,255,0.25);
  color: #fff;
  cursor: pointer;
  font-size: 15px;
}
.btn:hover { background: rgba(255,255,255,0.4); }

/* ===== –ö–∞—Ä—Ç–æ—á–∫–∞ ===== */
.card {
  max-width: 450px;
  margin: 0 auto;
  background: rgba(0,0,0,0.55);
  padding: 25px;
  text-align: center;
  border-radius: 16px;
  backdrop-filter: blur(10px);
}

input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  margin-bottom: 10px;
  font-size: 16px;
}
button.main {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg,#6ba8ff,#005fcc);
  font-size: 17px;
  color: white;
  cursor: pointer;
  font-weight: bold;
}
button.main:disabled {
  background: #666;
  cursor: not-allowed;
}

/* ===== –ò—Å—Ç–æ—Ä–∏—è ===== */
.history {
  text-align: left;
  padding: 10px;
  margin-top: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
}

/* ===== –ú–æ–¥–∞–ª–∫–∏ ===== */
.modal {
  position: fixed;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,.6);
}
.modal.show { display: flex; }

.modal-content {
  background: #fff;
  padding: 25px;
  width: 320px;
  border-radius: 12px;
  color: #000;
  text-align: center;
  position: relative;
}

body.dark .modal-content {
  background: #222;
  color: #fff;
}

.close {
  position: absolute;
  font-size: 24px;
  top: 8px; right: 14px;
  cursor: pointer;
}

</style>
</head>
<body>

<!-- ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å ===== -->
<div class="top-bar">
  <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
  <button class="btn" id="regBtn">–°–æ–∑–¥–∞—Ç—å</button>
  <button class="btn" id="logoutBtn" style="display:none;">–í—ã–π—Ç–∏</button>
  <button class="btn" id="themeBtn">üåô</button>
</div>

<!-- ===== –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ===== -->
<div class="card">
  <div id="statusText">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ</div><br>

  <input type="number" id="mileage" placeholder="–ü—Ä–æ–±–µ–≥ –≤ –∫–º" disabled>
  <button class="main" id="saveMileage" type="button" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <div id="history" class="history" style="display:none;"></div>
</div>

<!-- ===== –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ ===== -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <span class="close" data-close="loginModal">√ó</span>
    <h3>–í—Ö–æ–¥</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="main" id="loginSubmit" type="button">–í–æ–π—Ç–∏</button>
  </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ===== -->
<div class="modal" id="regModal">
  <div class="modal-content">
    <span class="close" data-close="regModal">√ó</span>
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <input id="regEmail" type="email" placeholder="Email">
    <input id="regPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="main" id="regSubmit" type="button">–°–æ–∑–¥–∞—Ç—å</button>
  </div>
</div>

<!-- ========== SCRIPT ========== -->
<script type="module">
/* ===== –¢–µ–º–∞ ===== */
const themeBtn = document.getElementById("themeBtn");
function applyTheme(){
  const dark = localStorage.theme === "dark";
  document.body.classList.toggle("dark", dark);
  themeBtn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
}
applyTheme();
themeBtn.onclick = () => {
  localStorage.theme = localStorage.theme === "dark" ? "light" : "dark";
  applyTheme();
};

/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import {
  getFirestore, collection, addDoc,
  query, where, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCuTQ4a2znu4NezpilyL2QAyMQHt5SAozE",
  authDomain: "focus3-df69e.firebaseapp.com",
  projectId: "focus3-df69e"
});

const auth = getAuth(app);
const db = getFirestore(app);

/* ===== –≠–ª–µ–º–µ–Ω—Ç—ã ===== */
const loginBtn = document.getElementById("loginBtn");
const regBtn = document.getElementById("regBtn");
const logoutBtn = document.getElementById("logoutBtn");

const loginModal = document.getElementById("loginModal");
const regModal = document.getElementById("regModal");

const loginSubmit = document.getElementById("loginSubmit");
const regSubmit = document.getElementById("regSubmit");

const statusText = document.getElementById("statusText");
const saveBtn = document.getElementById("saveMileage");
const mileage = document.getElementById("mileage");
const historyBox = document.getElementById("history");

/* ===== –ú–æ–¥–∞–ª–∫–∏ ===== */
loginBtn.onclick = ()=> loginModal.classList.add("show");
regBtn.onclick = ()=> regModal.classList.add("show");
document.querySelectorAll(".close").forEach(btn=>{
  btn.onclick = ()=> document.getElementById(btn.dataset.close).classList.remove("show");
});

/* ===== –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ===== */
loginSubmit.onclick = async ()=>{
  try {
    await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
    loginModal.classList.remove("show");
  } catch(err){ alert(err.message); }
};
regSubmit.onclick = async ()=>{
  try {
    await createUserWithEmailAndPassword(auth, regEmail.value, regPass.value);
    regModal.classList.remove("show");
  } catch(err){ alert(err.message); }
};
logoutBtn.onclick = ()=> signOut(auth);

/* ===== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–µ–≥–∞ ===== */
saveBtn.onclick = async ()=>{
  if(!auth.currentUser) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!");
  const val = Number(mileage.value);
  if(!val) return alert("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–±–µ–≥!");

  await addDoc(collection(db,"mileages"),{
    uid: auth.currentUser.uid,
    mileage: val,
    date: new Date().toISOString()
  });

  // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
  fetch("https://mileage-microservice.onrender.com/mileage", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      uid: auth.currentUser.uid,
      mileage: val,
      email: auth.currentUser.email,
      date: new Date().toISOString()
    })
  });

  mileage.value = "";
  loadHistory();
};

/* ===== –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 ===== */
async function loadHistory(){
  const user = auth.currentUser;
  if(!user) return;

  const q = query(
    collection(db,"mileages"),
    where("uid","==",user.uid),
    orderBy("date","desc"),
    limit(5)
  );
  const docs = await getDocs(q);

  historyBox.innerHTML = "";
  docs.forEach(d=>{
    const x = d.data();
    historyBox.innerHTML += `‚Ä¢ ${x.mileage} –∫–º (${new Date(x.date).toLocaleDateString()})<br>`;
  });

  historyBox.style.display = docs.size ? "block" : "none";
}

/* ===== –°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ –≤—Ö–æ–¥–æ–º ===== */
onAuthStateChanged(auth, user=>{
  if(user){
    statusText.textContent = `–í—ã –≤–æ—à–ª–∏: ${user.email}`;
    mileage.disabled = false;
    saveBtn.disabled = false;
    loginBtn.style.display = "none";
    regBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    loadHistory();
  } else {
    statusText.textContent = "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ";
    mileage.disabled = true;
    saveBtn.disabled = true;
    loginBtn.style.display = "inline-block";
    regBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    historyBox.innerHTML = "";
    historyBox.style.display = "none";
  }
});

</script>
</body>
</html>
